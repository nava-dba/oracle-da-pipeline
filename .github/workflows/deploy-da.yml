name: Deploy Oracle DA via Schematics

on:
  workflow_dispatch:
    inputs:
      deployment_type:
        description: "rac or si"
        required: true
        default: rac
        type: choice
        options:
          - rac
          - si

  issue_comment:
    types: [created]

jobs:
  deploy:
    if: |
      github.event_name == 'workflow_dispatch' ||
      contains(github.event.comment.body, '/run')

    runs-on: ubuntu-latest

    steps:
      - name: Determine deployment
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            DEPLOY="${{ inputs.deployment_type }}"
          else
            if [[ "${{ github.event.comment.body }}" == *"/run rac"* ]]; then
              DEPLOY="rac"
            elif [[ "${{ github.event.comment.body }}" == *"/run si"* ]]; then
              DEPLOY="si"
            else
              echo "Invalid command. Use /run rac or /run si"
              exit 1
            fi
          fi
          echo "DEPLOY=$DEPLOY" >> $GITHUB_ENV

      - name: Install IBM Cloud CLI
        run: |
          curl -fsSL https://clis.cloud.ibm.com/install/linux | sh
          ibmcloud --version

      - name: Install / Update Schematics plugin
        run: |
          ibmcloud plugin uninstall schematics -f || true
          ibmcloud plugin install schematics -f
          ibmcloud schematics version

      - name: IBM Cloud Login (Schematics account)
        env:
          IC_API_KEY: ${{ secrets.IC_API_KEY }}
        run: |
          ibmcloud login --apikey "$IC_API_KEY" -r us-south

      - name: Create or Update Schematics Workspace
        run: |
          if [[ "$DEPLOY" == "rac" ]]; then
            WS_NAME="oracle-da-rac"
            DIR="solutions/private/rac"
          else
            WS_NAME="oracle-da-si"
            DIR="solutions/private/si"
          fi

          ibmcloud schematics workspace create \
            --name "$WS_NAME" \
            --location us-south \
            --resource-group default \
            --git-repo-url https://github.com/${{ github.repository }} \
            --git-repo-folder "$DIR" \
            --git-branch main \
            || true

      - name: Get Workspace ID
        run: |
          WS_ID=$(ibmcloud schematics workspace list | grep oracle-da | awk '{print $1}')
          echo "WS_ID=$WS_ID" >> $GITHUB_ENV

      - name: Apply Schematics Workspace
        env:
          TF_VAR_IBMCLOUD_API_KEY: ${{ secrets.TF_VAR_IBMCLOUD_API_KEY }}
          TF_VAR_IBMCLOUD_COS_SERVICE_CREDENTIALS: ${{ secrets.TF_VAR_IBMCLOUD_COS_SERVICE_CREDENTIALS }}
          TF_VAR_ORA_DB_PASSWORD: ${{ secrets.TF_VAR_ORA_DB_PASSWORD }}
          TF_VAR_ROOT_PASSWORD: ${{ secrets.TF_VAR_ROOT_PASSWORD }}
          TF_VAR_SSH_PRIVATE_KEY: ${{ secrets.TF_VAR_SSH_PRIVATE_KEY }}
        run: |
          ibmcloud schematics workspace apply \
            --id "$WS_ID" \
            --force
