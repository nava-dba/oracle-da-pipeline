name: Deploy Oracle DA via Schematics

on:
  workflow_dispatch:
    inputs:
      deployment_type:
        required: true
        type: choice
        default: rac
        options:
          - rac
          - si

  issue_comment:
    types: [created]

jobs:
  deploy:
    if: |
      github.event_name == 'workflow_dispatch' ||
      contains(github.event.comment.body, '/run')

    runs-on: ubuntu-latest

    steps:
      - name: Determine deployment
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            DEPLOY="${{ inputs.deployment_type }}"
          else
            if [[ "${{ github.event.comment.body }}" == *"/run rac"* ]]; then
              DEPLOY="rac"
            elif [[ "${{ github.event.comment.body }}" == *"/run si"* ]]; then
              DEPLOY="si"
            else
              echo "Invalid command. Use '/run rac' or '/run si'"
              exit 1
            fi
          fi
          echo "DEPLOY=$DEPLOY" >> $GITHUB_ENV

      - name: Install IBM Cloud CLI
        run: |
          curl -fsSL https://clis.cloud.ibm.com/install/linux | sh

      - name: Install Schematics plugin
        run: |
          ibmcloud plugin uninstall schematics -f || true
          ibmcloud plugin install schematics -f

      - name: Login to IBM Cloud
        env:
          IC_API_KEY: ${{ secrets.IC_API_KEY }}
        run: |
          ibmcloud login --apikey "$IC_API_KEY" -r us-south
          echo "✓ Logged in successfully"

      - name: Set workspace variables
        run: |
          if [[ "$DEPLOY" == "rac" ]]; then
            echo "WS_NAME=oracle-da-rac" >> $GITHUB_ENV
            echo "GIT_FOLDER=solutions/private/rac" >> $GITHUB_ENV
          else
            echo "WS_NAME=oracle-da-si" >> $GITHUB_ENV
            echo "GIT_FOLDER=solutions/private/si" >> $GITHUB_ENV
          fi

      - name: Check if workspace exists
        id: check_workspace
        run: |
          echo "Checking for existing workspace: ${{ env.WS_NAME }}"
          
          # List all workspaces and search for our workspace name
          WS_LIST=$(ibmcloud schematics workspace list --output json 2>/dev/null || echo '{"workspaces":[]}')
          WS_ID=$(echo "$WS_LIST" | jq -r --arg name "${{ env.WS_NAME }}" '.workspaces[]? | select(.name==$name) | .id' | head -n1)
          
          if [[ -n "$WS_ID" && "$WS_ID" != "null" ]]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "WS_ID=$WS_ID" >> $GITHUB_ENV
            echo "✓ Found existing workspace: $WS_ID"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "No existing workspace found"
          fi

      - name: Create workspace (if new)
        if: steps.check_workspace.outputs.exists == 'false'
        run: |
          echo "Creating new workspace: ${{ env.WS_NAME }}"
          
          # Create workspace without resource group specification
          ibmcloud schematics workspace new \
            --name "${{ env.WS_NAME }}" \
            --location us-south \
            --template-type terraform_v1.5 \
            --template-git-url https://github.com/${{ github.repository }} \
            --template-git-folder "${{ env.GIT_FOLDER }}" \
            --template-git-branch main \
            --output json > workspace.json
          
          WS_ID=$(jq -r '.id' workspace.json)
          
          if [[ -z "$WS_ID" || "$WS_ID" == "null" ]]; then
            echo "Failed to create workspace"
            cat workspace.json
            exit 1
          fi
          
          echo "WS_ID=$WS_ID" >> $GITHUB_ENV
          echo "✓ Created workspace: $WS_ID"

      - name: Update workspace repository (if exists)
        if: steps.check_workspace.outputs.exists == 'true'
        run: |
          echo "Updating workspace repository settings"
          ibmcloud schematics workspace update \
            --id "${{ env.WS_ID }}" \
            --template-git-url https://github.com/${{ github.repository }} \
            --template-git-folder "${{ env.GIT_FOLDER }}" \
            --template-git-branch main
          echo "✓ Workspace updated"

      - name: Create Terraform variables file
        env:
          TF_VAR_IBMCLOUD_API_KEY: ${{ secrets.TF_VAR_IBMCLOUD_API_KEY }}
          TF_VAR_IBMCLOUD_COS_SERVICE_CREDENTIALS: ${{ secrets.TF_VAR_IBMCLOUD_COS_SERVICE_CREDENTIALS }}
          TF_VAR_ORA_DB_PASSWORD: ${{ secrets.TF_VAR_ORA_DB_PASSWORD }}
          TF_VAR_ROOT_PASSWORD: ${{ secrets.TF_VAR_ROOT_PASSWORD }}
          TF_VAR_SSH_PRIVATE_KEY: ${{ secrets.TF_VAR_SSH_PRIVATE_KEY }}
        run: |
          # Create a properly formatted JSON variables file
          # Using base64 encoding to handle special characters safely
          
          cat > variables.json <<EOF
          [
            {
              "name": "ibmcloud_api_key",
              "value": "${TF_VAR_IBMCLOUD_API_KEY}",
              "type": "string",
              "secure": true
            },
            {
              "name": "ibmcloud_cos_service_credentials",
              "value": $(echo -n "${TF_VAR_IBMCLOUD_COS_SERVICE_CREDENTIALS}" | jq -Rs .),
              "type": "string",
              "secure": true
            },
            {
              "name": "ora_db_password",
              "value": "${TF_VAR_ORA_DB_PASSWORD}",
              "type": "string",
              "secure": true
            },
            {
              "name": "root_password",
              "value": "${TF_VAR_ROOT_PASSWORD}",
              "type": "string",
              "secure": true
            },
            {
              "name": "ssh_private_key",
              "value": $(echo -n "${TF_VAR_SSH_PRIVATE_KEY}" | jq -Rs .),
              "type": "string",
              "secure": true
            }
          ]
          EOF
          
          echo "✓ Variables file created"

      - name: Upload variables to workspace
        run: |
          echo "Uploading Terraform variables to workspace"
          
          # Upload each variable individually for better error handling
          while IFS= read -r var; do
            VAR_NAME=$(echo "$var" | jq -r '.name')
            VAR_VALUE=$(echo "$var" | jq -r '.value')
            VAR_SECURE=$(echo "$var" | jq -r '.secure')
            
            echo "Setting variable: $VAR_NAME"
            
            if [[ "$VAR_SECURE" == "true" ]]; then
              ibmcloud schematics workspace update \
                --id "${{ env.WS_ID }}" \
                --var-name "$VAR_NAME" \
                --var-value "$VAR_VALUE" \
                --var-type string \
                --var-secure true
            else
              ibmcloud schematics workspace update \
                --id "${{ env.WS_ID }}" \
                --var-name "$VAR_NAME" \
                --var-value "$VAR_VALUE" \
                --var-type string
            fi
          done < <(jq -c '.[]' variables.json)
          
          echo "✓ All variables uploaded"

      - name: Run Terraform Plan
        id: plan
        run: |
          echo "Initiating Terraform plan..."
          
          PLAN_OUTPUT=$(ibmcloud schematics plan --id "${{ env.WS_ID }}" --output json)
          ACTIVITY_ID=$(echo "$PLAN_OUTPUT" | jq -r '.activityid')
          
          if [[ -z "$ACTIVITY_ID" || "$ACTIVITY_ID" == "null" ]]; then
            echo "Failed to start plan"
            echo "$PLAN_OUTPUT"
            exit 1
          fi
          
          echo "PLAN_ACTIVITY_ID=$ACTIVITY_ID" >> $GITHUB_ENV
          echo "✓ Plan started with Activity ID: $ACTIVITY_ID"

      - name: Monitor Plan execution
        run: |
          echo "Monitoring plan execution..."
          TIMEOUT=600  # 10 minutes
          ELAPSED=0
          INTERVAL=10
          
          while [ $ELAPSED -lt $TIMEOUT ]; do
            sleep $INTERVAL
            ELAPSED=$((ELAPSED + INTERVAL))
            
            ACTION_OUTPUT=$(ibmcloud schematics workspace action \
              --id "${{ env.WS_ID }}" \
              --act-id "${{ env.PLAN_ACTIVITY_ID }}" \
              --output json 2>&1)
            
            STATUS=$(echo "$ACTION_OUTPUT" | jq -r '.status // "PENDING"')
            
            echo "[$(date +%H:%M:%S)] Status: $STATUS (${ELAPSED}s elapsed)"
            
            case "$STATUS" in
              "COMPLETED")
                echo "✓ Plan completed successfully"
                exit 0
                ;;
              "FAILED")
                echo "✗ Plan failed"
                echo "Fetching logs..."
                ibmcloud schematics logs --id "${{ env.WS_ID }}" --act-id "${{ env.PLAN_ACTIVITY_ID }}" || true
                exit 1
                ;;
              "CANCELLED")
                echo "✗ Plan was cancelled"
                exit 1
                ;;
            esac
          done
          
          echo "✗ Plan timed out after ${TIMEOUT} seconds"
          exit 1

      - name: Run Terraform Apply
        id: apply
        run: |
          echo "Initiating Terraform apply..."
          
          APPLY_OUTPUT=$(ibmcloud schematics apply --id "${{ env.WS_ID }}" --force --output json)
          ACTIVITY_ID=$(echo "$APPLY_OUTPUT" | jq -r '.activityid')
          
          if [[ -z "$ACTIVITY_ID" || "$ACTIVITY_ID" == "null" ]]; then
            echo "Failed to start apply"
            echo "$APPLY_OUTPUT"
            exit 1
          fi
          
          echo "APPLY_ACTIVITY_ID=$ACTIVITY_ID" >> $GITHUB_ENV
          echo "✓ Apply started with Activity ID: $ACTIVITY_ID"

      - name: Monitor Apply execution
        run: |
          echo "Monitoring apply execution..."
          TIMEOUT=3600  # 60 minutes
          ELAPSED=0
          INTERVAL=30
          
          while [ $ELAPSED -lt $TIMEOUT ]; do
            sleep $INTERVAL
            ELAPSED=$((ELAPSED + INTERVAL))
            
            ACTION_OUTPUT=$(ibmcloud schematics workspace action \
              --id "${{ env.WS_ID }}" \
              --act-id "${{ env.APPLY_ACTIVITY_ID }}" \
              --output json 2>&1)
            
            STATUS=$(echo "$ACTION_OUTPUT" | jq -r '.status // "PENDING"')
            
            echo "[$(date +%H:%M:%S)] Status: $STATUS (${ELAPSED}s elapsed)"
            
            case "$STATUS" in
              "COMPLETED")
                echo "✓ Apply completed successfully"
                exit 0
                ;;
              "FAILED")
                echo "✗ Apply failed"
                echo "Fetching logs..."
                ibmcloud schematics logs --id "${{ env.WS_ID }}" --act-id "${{ env.APPLY_ACTIVITY_ID }}" || true
                exit 1
                ;;
              "CANCELLED")
                echo "✗ Apply was cancelled"
                exit 1
                ;;
            esac
          done
          
          echo "✗ Apply timed out after ${TIMEOUT} seconds"
          exit 1

      - name: Retrieve deployment outputs
        if: success()
        run: |
          echo "=========================================="
          echo "Deployment Outputs"
          echo "=========================================="
          ibmcloud schematics workspace output --id "${{ env.WS_ID }}" --output json | jq '.' || echo "No outputs available"

      - name: Deployment summary
        if: always()
        run: |
          echo "=========================================="
          echo "Deployment Summary"
          echo "=========================================="
          echo "Workspace Name: ${{ env.WS_NAME }}"
          echo "Workspace ID: ${{ env.WS_ID }}"
          echo "Deployment Type: ${{ env.DEPLOY }}"
          echo "Git Folder: ${{ env.GIT_FOLDER }}"
          echo "Status: ${{ job.status }}"
          echo "=========================================="

      - name: Comment on PR/Issue (success)
        if: github.event_name == 'issue_comment' && success()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body:  **Oracle DA Deployment Successful**
              
              **Configuration:** \`${{ env.DEPLOY }}\`
              **Workspace ID:** \`${{ env.WS_ID }}\`
              **Workspace Name:** \`${{ env.WS_NAME }}\`
              
              [View workflow run →](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})`
            })

      - name: Comment on PR/Issue (failure)
        if: github.event_name == 'issue_comment' && failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body:  **Oracle DA Deployment Failed**
              
              **Configuration:** \`${{ env.DEPLOY }}\`
              **Workspace ID:** \`${{ env.WS_ID || 'N/A' }}\`
              
              [View workflow run for details →](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})`
            })